apiVersion: v1
data:
  anyuid_test: |
    #!/bin/sh
    test_anyuid() {
      for project in ${USER_PROJECTS}; do
        count_anyuid_default=`oc describe scc anyuid -n ${project} | grep "Users:.*system:serviceaccount:.*:default" | wc -l`
        assertEquals " service account default in project ${project};" ${count_anyuid_default} 0
      done
    }
    suite_addTest test_anyuid
  exports: |
    #!/bin/sh
    export USER_PROJECTS=`oc get projects | grep -v "\(openshift\|kube\|default\|logging\)" | cut -d' ' -f1 | tail -n +2`
    export NODES=`oc get nodes | cut -d' ' -f1 | tail -n +2`
  limits_test: |
    #!/bin/sh
    test_project_quotas() {
      for project in ${USER_PROJECTS}; do
        limitrange=`oc get limitrange -n ${project} | wc -l`
        assertNotEquals " limitrange not set in project ${project};" $limitrange 0
        resourcequota=`oc get resourcequota -n ${project} | wc -l`
        assertNotEquals " resourcequota not set in project ${project};" $resourcequota 0
      done
    }
    suite_addTest test_project_quotas
  nodes_test: |
    #!/bin/sh
    test_nodes_ready() {
      for node in ${NODES}; do
        ready=`oc get node ${node} -o json | jq -r '.status.conditions[] | select(.type=="Ready") | .status'`
        assertEquals " node ${node} not ready;" $ready "True"
      done
    }
    test_nodes_no_warnings() {
      for node in ${NODES}; do
        warnings=`oc describe node/${node} | grep -A64 "^Events:" | grep "Warn" | wc -l`
        assertEquals " node ${node} has warnings;" 0 ${warnings}
      done
    }
    suite_addTest test_nodes_ready
    suite_addTest test_nodes_no_warnings
  privileged_test: |
    #!/bin/sh
    test_security_context_privileged() {
      for project in ${USER_PROJECTS}; do
        for pod in `oc get po -n ${project} | cut -d' ' -f1 | tail -n +2`; do
          count_privileged=`oc export po/${pod} -n ${project} -o json | jq -r '..|.securityContext?.privileged' | grep -c true`
          assertEquals " pod ${pod} in project ${project} runs with privileged security context;" ${count_privileged} 0
        done
      done
    }
    suite_addTest test_security_context_privileged
  self_provisioner_test: |
    #!/bin/sh
    test_self_provisioner() {
      count_self_provisioner=`oc adm policy who-can create projectrequests | grep system:authenticated | wc -l`
      assertEquals " authenticated users must not create project requests;" ${count_self_provisioner} 0
    }
    suite_addTest test_self_provisioner
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: openshift-unit
